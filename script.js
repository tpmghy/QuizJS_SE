// ‚ñº‚ñº‚ñº „Éì„É´„ÉâÁî®„ÅÆ„Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„Éº„ÇíÂâäÈô§ ‚ñº‚ñº‚ñº
// const API_URL = '__API_URL__';
// const SECRET_KEY = '__SECRET_KEY__';
// ‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤

/**
 * =================================================================
 *  „Éë„Çπ„ÉØ„Éº„ÉâË™çË®º
 * =================================================================
 */
const CORRECT_PASSWORD = 'your_password_here'; 
const passwordContainer = document.getElementById('password-container');
const passwordInput = document.getElementById('password-input');
const passwordSubmitBtn = document.getElementById('password-submit-btn');
const passwordError = document.getElementById('password-error');
const quizAppContainer = document.getElementById('quiz-app-container');
function checkPassword() {
    if (passwordInput.value === CORRECT_PASSWORD) {
        passwordContainer.style.display = 'none';
        quizAppContainer.style.display = 'flex';
        initializePage();
    } else {
        passwordError.textContent = '„Éë„Çπ„ÉØ„Éº„Éâ„ÅåÈÅï„ÅÑ„Åæ„Åô„ÄÇ';
        passwordInput.value = '';
        passwordInput.focus();
    }
}
passwordSubmitBtn.addEventListener('click', checkPassword);
passwordInput.addEventListener('keydown', (event) => {
    if (event.key === 'Enter') checkPassword();
});

/**
 * =================================================================
 *  HTMLË¶ÅÁ¥†„ÅÆÂèñÂæó
 * =================================================================
 */
// --- ÂêÑÁîªÈù¢„ÅÆ„Ç≥„É≥„ÉÜ„Éä ---
const startContainer = document.getElementById('start-container');
const videoContainer = document.getElementById('video-container');
const quizContainer = document.getElementById('quiz-container');
const resultContainer = document.getElementById('result-container');
const reviewContainer = document.getElementById('review-container');
const historyContainer = document.getElementById('history-container');
const progressContainer = document.getElementById('progress-container');
// --- „Çπ„Çø„Éº„ÉàÁîªÈù¢ ---
const historyButton = document.getElementById('history-btn');
const dashboardList = document.getElementById('dashboard-list');
// --- ÂãïÁîªÂ≠¶ÁøíÁîªÈù¢ ---
const videoTitle = document.getElementById('video-title');
const youtubePlayer = document.getElementById('youtube-player');
const proceedToQuizButton = document.getElementById('proceed-to-quiz-btn');
const backToStartFromVideoButton = document.getElementById('back-to-start-from-video-btn');
// --- „ÇØ„Ç§„Ç∫ÁîªÈù¢ ---
const questionElement = document.getElementById('question');
const choiceButtons = document.querySelectorAll('.choice-btn');
const feedbackElement = document.getElementById('feedback');
const currentGroupElement = document.getElementById('current-group');
// --- ÁµêÊûúÁîªÈù¢ ---
const scoreElement = document.getElementById('score');
const totalQuestionsElement = document.getElementById('total-questions');
const resultGroupNameElement = document.getElementById('result-group-name');
const reviewButton = document.getElementById('review-btn');
const backToStartButton = document.getElementById('back-to-start-btn');
// --- Ëß£Á≠î‰∏ÄË¶ßÁîªÈù¢ ---
const reviewList = document.getElementById('review-list');
const restartButton = document.getElementById('restart-btn');
const reviewGroupNameElement = document.getElementById('review-group-name');
const saveReviewImageButton = document.getElementById('save-review-image-btn');
// --- Â≠¶ÁøíÂ±•Ê≠¥ÁîªÈù¢ ---
const historyList = document.getElementById('history-list');
const backToStartFromHistoryButton = document.getElementById('back-to-start-from-history-btn');

/**
 * =================================================================
 *  „Ç≤„Éº„É†„ÅÆÁä∂ÊÖã„ÇíÁÆ°ÁêÜ„Åô„ÇãÂ§âÊï∞
 * =================================================================
 */
let quizData = [];
let currentQuestionIndex = 0;
let score = 0;
let currentGroupName = '';
let userAnswers = [];
let categoryTree = {};

/**
 * =================================================================
 *  „Éò„É´„Éë„ÉºÈñ¢Êï∞„ÅÆÂÆöÁæ© (localStorageÊìç‰Ωú)
 * =================================================================
 */
function getProgressData() {
    return JSON.parse(localStorage.getItem('quizProgress')) || {};
}
function updateProgressData(smallCode, dataToUpdate) {
    if (!smallCode || smallCode === 'all') return;
    try {
        const progressData = getProgressData();
        if (!progressData[smallCode]) {
            progressData[smallCode] = { videoViews: 0, correct: 0, total: 0 };
        }
        if (dataToUpdate.video) {
            progressData[smallCode].videoViews++;
        }
        if (dataToUpdate.score !== undefined) {
            progressData[smallCode].correct = dataToUpdate.score;
        }
        if (dataToUpdate.total !== undefined) {
            progressData[smallCode].total = dataToUpdate.total;
        }
        localStorage.setItem('quizProgress', JSON.stringify(progressData));
    } catch (e) { console.error('ÈÄ≤Êçó„Éá„Éº„Çø„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:', e); }
}

/**
 * =================================================================
 *  „É°„Ç§„É≥„ÅÆÈñ¢Êï∞ÂÆöÁæ©
 * =================================================================
 */
async function fetchQuizData(params) {
    quizContainer.style.display = 'block';
    questionElement.textContent = '„ÇØ„Ç§„Ç∫„ÇíË™≠„ÅøËæº„Åø‰∏≠...';
    feedbackElement.textContent = '';
    try {
        const query = new URLSearchParams(params).toString();
        const url = `${API_URL}?key=${SECRET_KEY}&${query}`;
        const response = await fetch(url);
        if (!response.ok) throw new Error(`API„Ç®„É©„Éº: ${response.status}`);
        quizData = await response.json();
        if (quizData.error) throw new Error(quizData.message);
        if (quizData.length === 0) throw new Error('Ë©≤ÂΩì„Åô„ÇãÂïèÈ°å„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ');
        startQuiz();
    } catch (error) {
        console.error('„ÇØ„Ç§„Ç∫„Éá„Éº„Çø„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:', error);
        questionElement.textContent = `„ÇØ„Ç§„Ç∫„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${error.message}`;
    }
}
function startQuiz() {
    currentQuestionIndex = 0;
    score = 0;
    userAnswers = [];
    startContainer.style.display = 'none';
    videoContainer.style.display = 'none';
    resultContainer.style.display = 'none';
    reviewContainer.style.display = 'none';
    historyContainer.style.display = 'none';
    progressContainer.style.display = 'none';
    quizContainer.style.display = 'block';
    showQuestion();
}
function showQuestion() {
    currentGroupElement.textContent = `„Ç´„ÉÜ„Ç¥„É™: ${currentGroupName}`;
    const currentQuestion = quizData[currentQuestionIndex];
    questionElement.textContent = `Á¨¨${currentQuestionIndex + 1}Âïè: ${currentQuestion.question}`;
    feedbackElement.innerHTML = '';
    feedbackElement.style.backgroundColor = 'transparent';
    choiceButtons.forEach((button, index) => {
        button.textContent = currentQuestion.choices[index];
        button.onclick = () => checkAnswer(index);
        button.disabled = false;
        button.style.backgroundColor = '';
        button.style.borderColor = '#ddd';
    });
}
function checkAnswer(selectedIndex) {
    choiceButtons.forEach(button => button.disabled = true);
    const currentQuestion = quizData[currentQuestionIndex];
    const isCorrect = selectedIndex === currentQuestion.answerIndex;
    userAnswers.push({
        question: currentQuestion.question,
        userChoice: currentQuestion.choices[selectedIndex],
        correctAnswer: currentQuestion.choices[currentQuestion.answerIndex],
        isCorrect: isCorrect
    });
    try {
        const historyData = JSON.parse(localStorage.getItem('quizHistory')) || {};
        const questionId = currentQuestion.id;
        if (!historyData[questionId]) {
            historyData[questionId] = { question: currentQuestion.question, correct: 0, incorrect: 0 };
        }
        if (isCorrect) {
            historyData[questionId].correct++;
        } else {
            historyData[questionId].incorrect++;
        }
        localStorage.setItem('quizHistory', JSON.stringify(historyData));
    } catch (e) { console.error('Â≠¶ÁøíÂ±•Ê≠¥„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:', e); }
    const feedbackText = document.createElement('p');
    if (isCorrect) {
        score++;
        feedbackText.innerHTML = `Ê≠£Ëß£ÔºÅüéâ<br>Ëß£Ë™¨: ${currentQuestion.explanation}`;
        feedbackElement.style.backgroundColor = '#e6ffed';
        choiceButtons[selectedIndex].style.borderColor = '#28a745';
    } else {
        const correctAnswerText = currentQuestion.choices[currentQuestion.answerIndex];
        feedbackText.innerHTML = `‰∏çÊ≠£Ëß£...üò¢ Ê≠£Ëß£„ÅØ„Äå${correctAnswerText}„Äç<br>Ëß£Ë™¨: ${currentQuestion.explanation}`;
        feedbackElement.style.backgroundColor = '#ffebee';
        choiceButtons[selectedIndex].style.borderColor = '#dc3545';
        choiceButtons[currentQuestion.answerIndex].style.backgroundColor = '#d1e7dd';
    }
    feedbackElement.innerHTML = '';
    feedbackElement.appendChild(feedbackText);
    const nextButton = document.createElement('button');
    nextButton.className = 'next-btn';
    const isLastQuestion = currentQuestionIndex === quizData.length - 1;
    nextButton.textContent = isLastQuestion ? 'ÁµêÊûú„ÇíË¶ã„Çã' : 'Ê¨°„ÅÆÂïèÈ°å„Å∏';
    nextButton.addEventListener('click', () => {
        if (isLastQuestion) { showResult(); } else { currentQuestionIndex++; showQuestion(); }
    });
    feedbackElement.appendChild(nextButton);
}
function showResult() {
    quizContainer.style.display = 'none';
    resultContainer.style.display = 'block';
    resultGroupNameElement.textContent = currentGroupName;
    scoreElement.textContent = score;
    totalQuestionsElement.textContent = quizData.length;
    const smallCode = document.body.dataset.currentSmallCode;
    updateProgressData(smallCode, { score: score, total: quizData.length });
}
function showReview() {
    resultContainer.style.display = 'none';
    reviewContainer.style.display = 'block';
    reviewGroupNameElement.textContent = currentGroupName;
    reviewList.innerHTML = '';
    userAnswers.forEach((answer, index) => {
        const reviewItem = document.createElement('div');
        reviewItem.className = 'review-item';
        const resultMark = answer.isCorrect ? '<span class="mark correct">Ê≠£Ëß£ ‚úì</span>' : '<span class="mark incorrect">‰∏çÊ≠£Ëß£ ‚úó</span>';
        let answerHTML = `<p class="review-question">Q${index + 1}. ${answer.question} ${resultMark}</p><p class="review-user-answer">„ÅÇ„Å™„Åü„ÅÆÂõûÁ≠î: ${answer.userChoice}</p>`;
        if (!answer.isCorrect) { answerHTML += `<p class="review-correct-answer">Ê≠£Ëß£: ${answer.correctAnswer}</p>`; }
        reviewItem.innerHTML = answerHTML;
        reviewList.appendChild(reviewItem);
    });
}
async function saveReviewAsImage() {
    saveReviewImageButton.disabled = true;
    saveReviewImageButton.textContent = 'ÁîªÂÉèÁîüÊàê‰∏≠...';
    reviewList.style.maxHeight = 'none';
    reviewList.style.overflowY = 'visible';
    try {
        const canvas = await html2canvas(reviewContainer, { backgroundColor: '#ffffff', scale: 2 });
        const imageUrl = canvas.toDataURL('image/png');
        const downloadLink = document.createElement('a');
        const date = new Date();
        const formattedDate = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
        downloadLink.download = `quiz_review_${formattedDate}.png`;
        downloadLink.href = imageUrl;
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);
    } catch (error) { console.error('ÁîªÂÉè„ÅÆÁîüÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:', error); alert('ÁîªÂÉè„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ'); }
    finally {
        reviewList.style.maxHeight = '400px';
        reviewList.style.overflowY = 'auto';
        saveReviewImageButton.disabled = false;
        saveReviewImageButton.textContent = 'Ëß£Á≠î„ÇíÁîªÂÉè„Åß‰øùÂ≠ò';
    }
}
function showHistory() {
    startContainer.style.display = 'none';
    historyContainer.style.display = 'block';
    historyList.innerHTML = '';
    const historyData = JSON.parse(localStorage.getItem('quizHistory')) || {};
    const questionIds = Object.keys(historyData);
    if (questionIds.length === 0) { historyList.innerHTML = '<p>„Åæ„Å†Â≠¶ÁøíÂ±•Ê≠¥„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</p>'; return; }
    questionIds.forEach(id => {
        const record = historyData[id];
        const historyItem = document.createElement('div');
        historyItem.className = 'history-item';
        let historyHTML = `<p class="history-question">${record.question}</p><div class="history-stats"><span class="history-correct">Ê≠£Ëß£: ${record.correct}Âõû</span><span class="history-incorrect">‰∏çÊ≠£Ëß£: ${record.incorrect}Âõû</span></div>`;
        historyItem.innerHTML = historyHTML;
        historyList.appendChild(historyItem);
    });
}
function showStartScreen() {
    startContainer.style.display = 'block';
    videoContainer.style.display = 'none';
    quizContainer.style.display = 'none';
    resultContainer.style.display = 'none';
    reviewContainer.style.display = 'none';
    historyContainer.style.display = 'none';
    progressContainer.style.display = 'none';
    youtubePlayer.src = '';
    showDashboard();
}
function handleStartFromDashboard(largeCode, mediumCode, smallCode, actionType) {
    const largeCat = categoryTree[largeCode];
    const mediumCat = largeCat.children[mediumCode];
    const smallCat = mediumCat.children[smallCode];
    currentGroupName = `${largeCat.name} > ${mediumCat.name} > ${smallCat.name}`;
    const videoId = smallCat.videoId;
    const params = { l: largeCode, m: mediumCode, s: smallCode };
    document.body.dataset.currentSmallCode = smallCode;
    startContainer.style.display = 'none';
    if (actionType === 'watch' && videoId) {
        showVideoScreen(videoId, params);
        updateProgressData(smallCode, { video: true });
    } else {
        fetchQuizData(params);
    }
}
function showVideoScreen(videoId, quizParams) {
    videoTitle.textContent = `Â≠¶ÁøíÂãïÁîª: ${currentGroupName}`;
    youtubePlayer.src = `https://www.youtube.com/embed/${videoId}`;
    videoContainer.style.display = 'block';
    const newButton = proceedToQuizButton.cloneNode(true);
    proceedToQuizButton.parentNode.replaceChild(newButton, proceedToQuizButton);
    newButton.addEventListener('click', () => {
        videoContainer.style.display = 'none';
        youtubePlayer.src = '';
        fetchQuizData(quizParams);
    });
}
function showDashboard() {
    dashboardList.innerHTML = '';
    const progressData = getProgressData();
    let hasContent = false;
    for (const largeCode in categoryTree) {
        const largeCat = categoryTree[largeCode];
        const largeHeader = document.createElement('h3');
        largeHeader.className = 'dashboard-large-cat';
        largeHeader.textContent = largeCat.name;
        dashboardList.appendChild(largeHeader);
        for (const mediumCode in largeCat.children) {
            const mediumCat = largeCat.children[mediumCode];
            for (const smallCode in mediumCat.children) {
                hasContent = true;
                const smallCat = mediumCat.children[smallCode];
                const record = progressData[smallCode] || { videoViews: 0, correct: 0, total: 0 };
                const item = document.createElement('div');
                item.className = 'dashboard-item';
                const scoreText = record.total > 0 ? `${record.correct} / ${record.total}` : 'Êú™ÊåëÊà¶';
                const scoreClass = record.total > 0 && record.correct === record.total ? 'perfect' : '';
                item.innerHTML = `
                    <div class="dashboard-cat-name">
                        <span class="medium-cat">${mediumCat.name}</span>
                        <span class="small-cat">${smallCat.name}</span>
                    </div>
                    <div class="dashboard-progress">
                        <span>Ë¶ñËÅ¥: ${record.videoViews}Âõû</span>
                        <span class="score ${scoreClass}">„ÇØ„Ç§„Ç∫: ${scoreText}</span>
                    </div>
                `;
                const buttonContainer = document.createElement('div');
                buttonContainer.className = 'dashboard-buttons';
                const watchButton = document.createElement('button');
                watchButton.className = 'dashboard-watch-btn';
                watchButton.textContent = 'ÂãïÁîª';
                if (!smallCat.videoId) {
                    watchButton.disabled = true;
                }
                watchButton.addEventListener('click', () => handleStartFromDashboard(largeCode, mediumCode, smallCode, 'watch'));
                const quizButton = document.createElement('button');
                quizButton.className = 'dashboard-quiz-btn';
                quizButton.textContent = '„ÇØ„Ç§„Ç∫';
                quizButton.addEventListener('click', () => handleStartFromDashboard(largeCode, mediumCode, smallCode, 'quiz'));
                buttonContainer.appendChild(watchButton);
                buttonContainer.appendChild(quizButton);
                item.appendChild(buttonContainer);
                dashboardList.appendChild(item);
            }
        }
    }
    if (!hasContent) {
        dashboardList.innerHTML = '<p>Ë°®Á§∫„Åß„Åç„Çã„Ç´„ÉÜ„Ç¥„É™„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</p>';
    }
}

/**
 * =================================================================
 *  „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÅÆË®≠ÂÆö
 * =================================================================
 */
reviewButton.addEventListener('click', showReview);
backToStartButton.addEventListener('click', showStartScreen);
saveReviewImageButton.addEventListener('click', saveReviewAsImage);
restartButton.addEventListener('click', showStartScreen);
historyButton.addEventListener('click', showHistory);
backToStartFromHistoryButton.addEventListener('click', showStartScreen);
backToStartFromVideoButton.addEventListener('click', showStartScreen);

/**
 * =================================================================
 *  ÂàùÊúüÂåñÂá¶ÁêÜ
 * =================================================================
 */
async function initializePage() {
    const params = new URLSearchParams(window.location.search);
    const l = params.get('l');
    const m = params.get('m');
    const s = params.get('s');
    try {
        dashboardList.innerHTML = '<p>„Ç´„ÉÜ„Ç¥„É™„ÇíË™≠„ÅøËæº„Åø‰∏≠...</p>';
        const url = `${API_URL}?key=${SECRET_KEY}&action=get_category_tree`;
        const response = await fetch(url);
        if (!response.ok) throw new Error('„Ç´„ÉÜ„Ç¥„É™„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
        categoryTree = await response.json();
        if (l && m && s && categoryTree[l]?.children[m]?.children[s]) {
            startContainer.style.display = 'none';
            handleStartFromDashboard(l, m, s, 'quiz');
        } else {
            showDashboard();
        }
    } catch (error) {
        console.error(error);
        startContainer.innerHTML = '<h2>„Ç®„É©„Éº</h2><p>„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„Éö„Éº„Ç∏„ÇíÂÜçË™≠„ÅøËæº„Åø„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>';
    }
}
// „Éë„Çπ„ÉØ„Éº„ÉâË™çË®ºÊàêÂäüÂæå„Å´initializePage„ÅåÂëº„Å∞„Çå„Çã